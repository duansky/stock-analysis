# Stock-Analysis 项目回测功能使用指南

## 项目简介

Stock-Analysis 是一个基于Python的股票量化分析项目，主要功能包括：
- 从通达信软件导入历史数据
- 实现自定义选股策略
- 策略回测验证
- 盘中/盘后选股

项目的核心优势是使用本地通达信数据，避免了网络数据源的限制，确保数据的稳定性和完整性。

## 回测功能架构

回测功能基于以下组件：
- **数据层**: 通达信本地数据 → CSV/Pickle格式
- **策略层**: 自定义策略文件 (CeLue.py)
- **信号层**: 策略信号生成和保存 (celue_save.py)
- **回测层**: RQAlpha量化回测框架 (huice.py)

## 环境准备

### 1. 软件依赖

#### 必需软件
- **通达信软件**: 开心果版本 v2020.12 或更高版本
- **Python**: 3.8.5 (推荐使用Anaconda)
- **RQAlpha**: 4.2.5 量化回测框架

#### Python依赖包
```bash
pip install -r requirements.txt
```

主要依赖包：
- `pandas>=1.3.0` - 数据处理
- `numpy>=1.20.0` - 数值计算
- `talib>=0.4.19` - 技术指标计算
- `pytdx>=1.72` - 通达信数据接口
- `rqalpha>=4.2.5` - 量化回测框架
- `tqdm>=4.60.0` - 进度条显示
- `rich>=10.0.0` - 终端美化输出
- `pyecharts>=1.9.0` - 图表绘制

### 2. 数据准备

#### 通达信数据下载
1. **日线数据下载**
   - 打开通达信软件
   - 菜单: 系统 → 盘后数据下载
   - 下载沪深日线数据，日期从19900101至当天
   - 建议使用固态硬盘存储，需要约4GB空间

2. **财务数据下载**
   - 菜单: 系统 → 专业财务数据
   - 下载全部财务数据包

#### 目录结构配置
在 `user_config.py` 中配置数据路径：
```python
tdx = {
    'tdx_path': 'd:/通达信金融终端(开心果整合版)V2023.11自用版',
    'csv_lday': 'd:/TDXdata/lday_qfq',      # 日线数据目录
    'pickle': 'd:/TDXdata/pickle',          # Pickle格式数据目录
    'csv_index': 'd:/TDXdata/index',        # 指数数据目录
    'csv_cw': 'd:/TDXdata/cw',             # 财务数据目录
    'csv_gbbq': 'd:/TDXdata',              # 股本变迁数据目录
}
```

## 回测功能使用步骤

### 第一步：数据导入和更新

#### 1.1 初次数据导入
```bash
# 导入财务和股权变迁数据
python readTDX_cw.py

# 导入日线数据（首次运行，会处理全部历史数据）
python readTDX_lday.py
```

#### 1.2 日常数据更新
每个交易日16:00后，通达信更新当日数据后：
```bash
# 更新财务数据
python readTDX_cw.py

# 更新日线数据（只更新新增数据，速度快）
python readTDX_lday.py

# 强制重新生成全部数据（如有需要）
python readTDX_lday.py del
```

### 第二步：策略开发

#### 2.1 策略文件结构
主要策略文件：`CeLue.py`

核心函数：
- `策略HS300()`: 大盘环境判断
- `策略1()`: 基础筛选条件
- `策略2()`: 主要买入策略
- `卖策略()`: 卖出策略

#### 2.2 策略示例（连续涨5天策略）
```python
def 策略2(df, HS300_信号, start_date='', end_date=''):
    """连续涨5天选股策略主逻辑"""
    
    # 计算每日涨跌幅
    当日涨幅 = (C / REF(C, 1) - 1) * 100
    
    # 连续5天都上涨
    连续5天上涨 = (今日上涨 & 
                  (REF(当日涨幅, 1) > 0) & 
                  (REF(当日涨幅, 2) > 0) & 
                  (REF(当日涨幅, 3) > 0) & 
                  (REF(当日涨幅, 4) > 0))
    
    # 综合买入条件
    买入信号 = (HS300_信号 & 策略1条件 & 连续5天上涨 & 成交量条件 & 涨幅合理)
    
    return 买入信号
```

### 第三步：策略信号生成

#### 3.1 生成策略信号
```bash
# 为所有股票生成策略买卖信号（多进程，推荐）
python celue_save.py

# 单进程执行（调试用）
python celue_save.py single

# 完全重新生成策略信号（修改策略后必须执行）
python celue_save.py del
```

#### 3.2 输出文件
- 各股票CSV文件：添加 `celue_buy` 和 `celue_sell` 列
- `celue汇总.csv`：所有策略信号汇总，用于回测

### 第四步：执行回测

#### 4.1 回测参数配置
在 `huice.py` 中配置回测参数：
```python
# 回测时间范围
start_date = "2025-01-01"
end_date = "2025-12-31"

# 资金设置
stock_money = 10000000  # 初始资金（1000万）

# 下单模式选择
order_type = 'order_target_value'  # 固定金额模式
xiadan_target_value = 100000       # 每只股票买入10万元

# 或者使用百分比模式
order_type = 'order_percent'       # 百分比模式
xiadan_percent = 0.1               # 每只股票占总资产10%
```

#### 4.2 执行回测
```bash
python huice.py
```

#### 4.3 回测输出
回测完成后会生成：
- **PNG图表**: `rq_result/时间戳_回测结果.png` - 收益曲线图
- **PKL文件**: `rq_result/时间戳_回测结果.pkl` - 详细回测数据
- **终端输出**: 回测摘要信息

### 第五步：结果分析

#### 5.1 回测摘要信息
```
回测起点 2025-01-01
回测终点 2025-12-31
回测收益 15.23%    年化收益 15.23%
基准收益 8.45%     基准年化 8.45%
最大回撤 -5.67%
```

#### 5.2 详细分析数据
PKL文件包含：
- `summary`: 回测摘要
- `stock_portfolios`: 股票账户市值变化
- `total_portfolios`: 总账户市值变化
- `benchmark_portfolios`: 基准收益变化
- `trades`: 交易明细（交割单）
- `stock_positions`: 股票持仓记录

#### 5.3 可视化分析
```bash
# 生成K线图和策略信号可视化
python plot.py
```
生成 `pyecharts.html` 文件，显示：
- 个股K线图
- 策略买卖点标记
- 持仓区间高亮（红色盈利，绿色亏损）

## 高级功能

### 盘中选股
```bash
# 盘中选股（交易时间内）
python xuangu.py
```
- 自动获取实时行情数据
- 结合历史数据进行选股
- 输出当日符合策略的股票列表

### 策略优化建议

#### 1. 策略参数优化
- 调整连续上涨天数
- 优化涨幅阈值
- 增加成交量过滤条件

#### 2. 风险控制
- 设置止盈止损点
- 控制单只股票仓位
- 增加大盘环境过滤

#### 3. 性能优化
- 使用多进程处理
- 优化数据存储格式
- 减少不必要的计算

## 常见问题解决

### 1. 数据问题
**问题**: 数据更新失败
**解决**: 
- 确保通达信软件正常运行
- 检查数据路径配置
- 手动更新通达信数据

### 2. 策略问题
**问题**: 策略信号异常
**解决**:
- 检查策略逻辑
- 使用 `python celue_save.py del` 重新生成
- 在策略文件中添加调试代码

### 3. 回测问题
**问题**: 回测结果不合理
**解决**:
- 检查回测时间范围
- 验证策略信号文件
- 调整回测参数设置

### 4. 性能问题
**问题**: 处理速度慢
**解决**:
- 使用固态硬盘存储数据
- 启用多进程处理
- 优化策略计算逻辑

## 注意事项

1. **数据完整性**: 确保通达信数据完整更新
2. **策略修改**: 修改策略后必须重新生成信号
3. **时间同步**: 注意回测时间范围与数据时间范围的匹配
4. **资金管理**: 合理设置初始资金和仓位控制
5. **风险提示**: 回测结果仅供参考，实盘交易需谨慎

## 扩展开发

### 自定义策略开发
1. 参考 `CeLue模板.py` 创建新策略
2. 实现必要的策略函数
3. 测试策略逻辑
4. 生成策略信号并回测

### 接入自动交易
项目支持对接自动交易系统：
- 买入信号：`xuangu.py` 输出的股票列表
- 卖出信号：持仓股票的卖出策略判断

---

**项目地址**: 
- GitHub: https://github.com/wkingnet/stock-analysis
- Gitee: https://gitee.com/wkingnet/stock-analysis

**免责声明**: 本项目仅用于学习和研究目的，投资有风险，入市需谨慎。